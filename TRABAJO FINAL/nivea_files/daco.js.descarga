'use strict';const Area={MAIN:'main',MAP:'map',CLIENT_DOM:'clientdom'},moduleType={WTB:1,BT:3,VT:4};class Tracker{constructor(e,t,a){if(this._wtbConf=t,this.logHost=Utils.changeAWSEndpoint('https://trace.swaven.com/log',this._wtbConf.region),this.moduleName=(Object.entries(moduleType).find((e=>e[1]===this._wtbConf.module))||['WTB'])[0].toLowerCase(),this.trkHost=Utils.setTrackingHost(this.moduleName.toUpperCase(),this._wtbConf.region),this._urlRegExp=new RegExp('^(https?:)?//'),this._country=1===t.countries.length?t.countries[0]:null,this.customTrackingOldNaming=e.customTrackingOldNaming,this.fmt=app.isMedia?`${e.width}x${e.height}`:'awe',this._offset=a,this.session=e.session,this.template=e.templatePath,this.rfr=e.referrer,this.rfr2=e.referrer2.substring(0,2048),this.trackingPixels=e.trackingPixels,this.hasPrices=+!(!e.hasPrices||!app.displayPrices),this.test=+!(!app.test&&!e.renderContext),this.openerIdx=null,this.availReqId=null,this.hasDroppedLiveRampPixel=!1,this.dntDefault=e.dntDefault,this._dntQueue=[],this._customTrkVars=null,e.customTrkVars&&(this._customTrkVars={},Object.entries(e.customTrkVars).forEach((([e,t])=>{this._customTrkVars['cust_'+e]=t}))),this.build=e.build,this.buildName=window.location.pathname.match(/awe\/\d+.\w+\/(\w+)/)?.[1]||'',this.pageId=e.pageId,t.callbackactions&&t.callbackactions.includes('deploy')&&(t.callbackactions[t.callbackactions.indexOf('deploy')]='dploy'),app.withSafeFrame&&(this.safeFrameDetector='framework'),this.consentMap=this._buildConsentMap(t.trkcfg),Tracker.dropTag('pv',{auto:!0}),app.isMedia){const e=setTimeout((()=>{hostCom.off('awe:clicktag',t)}),2e4),t=a=>{this.clicktag=a.clicktag,Tracker.log('clicktagUpdate'),a.stop&&(hostCom.off('awe:clicktag',t),clearTimeout(e))};hostCom.on('awe:clicktag',t)}hostCom.on('awe:tracking',(e=>{if(!e.params||!e.params.event)return;e.params.area||(e.params.area=Area.CLIENT_DOM);const t=e.params.event;delete e.params.event,Tracker.dropTag(t,e.params)})),hostCom.on('awe:log',(e=>{e.params||(e.params={}),e.params.area||(e.params.area=Area.CLIENT_DOM),Tracker.log(e.params.event,e.params)})),hostCom.on('awe:dnt',(e=>{app.dnt!==e.params.enabled&&(app.dnt=e.params.enabled,app.dnt||this._flushDNT(e.params.session),app.dnt||!this._wtbConf.operator?.isLiveRampEnabled||this.hasDroppedLiveRampPixel||this._dropLiveRampPixel())})),hostCom.on('awe:consentChange',(e=>{this.consentChange(e.params)})),Tracker.ready=!0,Tracker.ref=this,this.emptyQueue(),this.dntDefault&&!app.dnt&&this._wtbConf.operator?.isLiveRampEnabled&&!this.hasDroppedLiveRampPixel&&this._dropLiveRampPixel(),window.ReportingObserver&&this._setObserver()}_setObserver(){new ReportingObserver(((e,t)=>{e.forEach((e=>{console.debug(`Triggered a ${e.type} report`);const t={reportType:e.type,cpus:navigator.hardwareConcurrency,memory:navigator.deviceMemory};for(let a in e.body)'function'!=typeof e.body[a]&&null!=e.body[a]&&(t[a]=e.body[a]);Tracker.log('report',t)}))}),{types:['deprecation','intervention','crash']}).observe()}_addPixel(e){const t=document.createElement('img');t.style.display='none',t.src=e,t.setAttribute('role','none'),t.setAttribute('alt','event-data'),t.setAttribute('title','event-data'),t.onload=function(e){e?.currentTarget?.remove()},document.body.appendChild(t)}_dropLiveRampPixel(){const e=encodeURIComponent(`wtbid=${app.wtbid}`);this._addPixel(`https://di.rlcdn.com/api/segment?pid=712896&pdata=${e}`),this.hasDroppedLiveRampPixel=!0}_dropTag(e,t){t.ts=performance.now();const a=this._getTrackingParam(e,t);let r;t.log||(r=this._getCustomTrkData(e,t),this._customTracking(e,r)),app.dnt?this._dntQueue.push({action:e,payload:a}):this._immediateDropTag(e,a)}_immediateDropTag(e,t){const{s_url:a,...r}=t;let i=Object.entries(r).filter((([e,t])=>null!=t&&''!==t)).map((([e,t])=>`${encodeURIComponent(e)}=${encodeURIComponent(t)}`)).join('&');a&&(i+=`&s_url=${encodeURIComponent(a)}`),i+=`&rfr2=${encodeURIComponent(this.rfr2)}`,this.rfr&&(i+=`&rfr=${encodeURIComponent(this.rfr)}`);const s='buy'===e&&navigator.sendBeacon;if(s?navigator.sendBeacon(`${this.logHost}/${e}?${i}&beacon=1`):this._addPixel(`${this.logHost}/${e}?${i}`),!t.log){s&&navigator.sendBeacon(`${this.trkHost}/post?action=${e}&${i}&beacon=1`);let t=e.replace('buy','buypx');this._addPixel(`${this.trkHost}/px.png?action=${t}&${i}`)}app.$refs.logger&&app.$refs.logger.logTrk(e,r)}static dropTag(e,t={}){Tracker.ready?Tracker.ref._dropTag(e,t):Tracker.enqueue(e,t)}static log(e,t={}){t.log=1,Tracker.ready?Tracker.ref._dropTag(e,t):Tracker.enqueue(e,t)}static enqueue(e,t){Tracker._queue||(Tracker._queue=new Set),Tracker._queue.add({action:e,params:t})}dropClicktag(e){app.withSafeFrame?(this._addPixel(this.clicktag),this._dropTag('clicktag',{url:this.clicktag,trigger:e})):hostCom.send('awe:clicktag',{trigger:e})}_getTrackingParam(e,t={}){var a=app.getTrkData();let r={wtbid:this._wtbConf.Id,fmt:this.fmt,module:this.moduleName,type:'awe',v:Date.now(),lang:app.locale,opscode:this._wtbConf.opscode||'',area:t.area||Area.MAIN,pageid:this.pageId,iid:window.name,reqpid:app.eans,ct:this._country,ct_context:app.country,geocountry:this._wtbConf.geoCountry,touchpoint:this._wtbConf.touchPoint,dpr:this.hasPrices,test:this.test,template:this.template,trkOrigin:'daco',tzOffset:(new Date).getTimezoneOffset()};if(app.isMedia&&app.layoutName&&(r.layout=app.layoutName),app.masterProductMode&&app.productGroups&&app.product&&(r.pids=app.productGroups.get(app.product).map((e=>e.ean))),'pv'!==e&&'dploy'!==e&&(t.avail?.product||app.product)&&(r.pid=t.avail?.product?.ean||app.product.ean),null!=a.avgpc&&(r.avgpc=a.avgpc),null!=a.avgdst&&(r.avgdist=a.avgdst),null!=a.nbres&&(r.nbres=a.nbres),null!=a.nbrefret&&(r.nbrefret=a.nbrefret),null!=app.appId&&(r.appid=app.appId),this.availReqId&&(r.avreqid=this.availReqId),this.session&&(r=this._setSession(r)),null!=this.openerIdx&&(r.opnIdx=this.openerIdx),this._customTrkVars&&(r=Object.assign(r,this._customTrkVars)),null!=t.outbound&&(r.outbound=+!!t.outbound,delete t.outbound),'UNAVAILABLE_COUNTRY_ERROR'===app.error&&(r.oos=1),t.avail){const e=this._getAvailParams(t.avail);Object.entries(e).forEach((([e,t])=>r[e]=t))}switch(e){case'pv':r.auto=1;break;case'dploy':r.auto=+!!t.auto,t.opnidx&&(r.opnidx=t.opnidx),t.src&&(r.src=t.src);break;case'buy':t.avail&&(t.avail.clkUrlAffiliate&&(r.clkurlaff_prgid=t.avail.retailer.affiliatePrgId),r.clkurlaff=+!!t.avail.clkUrlAffiliate,r.clkurlt=t.avail.clkUrlType),t.leadid&&(r.leadid=t.leadid),r.auto=+!!t.auto;break;case'geoloc':r.auto=0;break;case'clkloc':r.clkloc_type=t.clkloc_type||'map','retailerHome'===r.clkloc_type&&(r.rid=t.avail.retailer.id,r.rurl=t.avail.retailer.url);case'clkRoute':case'appointment':case'showmap':r.auto=+!!t.auto;break;case'clk':r.auto=+!!t.auto,r.autoSel=+!!t.autoSel;break;case'apires':r.sids=app.getStoreIds(),r.auto=1;break;case'close':r.auto=+!!t.auto;break;case'unavlbsids':r.auto=1,r.sids=t.sids;break;case'storedisplayed':r.auto=+!!t.auto,r.sids=t.sids;break;case'clkout':case'custredirect':r.auto=+!!t.auto;break;case'clicktag':r.url=t.url,r.swavenDomain=+/\/\/[^\/]+?\bswaven\b/i.test(r.url),r.trigger=t.trigger;break;case'btn':case'btn_unavailable':r.reqpid=t.reqpid,r.idx=t.idx;break;default:r=Object.assign(r,t)}return r.build=this.build,r.buildName=this.buildName,r.safeframe=+app.withSafeFrame,app.withSafeFrame&&(r.safeframeDetector=this.safeFrameDetector),r.ts=Math.floor(this._offset+t.ts),app.renderContext&&(r.renderctx=app.renderContext),app.draft&&(r.draft=1),r}_setSession(e){return this.session.ts&&(e.s_ts=this.session.ts),this.session.url&&(e.s_url=this.session.url),this.session.referrer&&(e.s_referrer=this.session.referrer),this.session.id&&(e.s_id=this.session.id),e}_getAvailParams(e){return{prc:e.price.amount,dist:e.store.distance,dlv:this._getDlvParam(e.store),sid:e.store.id,sids:app.getStoreIds(),avpid:e.product.ean,retpid:e.product.retailerPdtId}}_getDlvParam(e){return e.drive||e.collect?'driveOrCollect':e.brick?'brick':e.homeDelivery?'HD':''}_customTracking(e,t){if(!this._wtbConf.callbackenabled||this._wtbConf.callbackactions&&0!==this._wtbConf.callbackactions.length&&!this._wtbConf.callbackactions.includes(e)||(this.trackingPixels&&this._dropClientPixels(t),hostCom.send('awe:trackingCallback',{trkData:t})),this._wtbConf.trkcfg){let a=this._wtbConf.trkcfg.actions.filter((a=>a.Code===e&&(!a.retid||a.retid===t.retailer?.id)));a.length>0&&this._serverTracking(a,t)}}_getCustomTrkData(e,t={}){const a=app.getLocation();let r={action:e,ts:Date.now(),wtbid:this._wtbConf.Id,fmt:this.fmt,type:'awe',ids:app.eans,auto:!!t.auto,location:{address:a.address,city:a.city,zipCode:a.zipCode,region:a.region,country:a.country,latitude:a.latitude,longitude:a.longitude}},i=app.product;if(app.multiOffer&&t.avail)if(app.masterProductMode){const e=app.productGroups.values();let a,r;for(;(r=e.next().value)&&(a=r.find((e=>e.ean===t.avail.product.ean)),!a););i=a}else i=app.products.find((e=>e.ean===t.avail.product.ean));null!=this.openerIdx&&(r.sticky=!(0!=this.openerIdx)),app.isMedia&&app.layoutName&&(r.layout=app.layoutName);const s=app.getTrkData();return s.nbres&&(r.resultCount=s.nbres),i&&Object.keys(i).length>0&&(r.product={id:i.id,ean:i.ean,name:Utils.removeHTML(i.name),name2:Utils.removeHTML(i.name2),pkg:Utils.removeHTML(i.pkg),brand:i.brand,model:i.model,categoryName:i.catName,sourcePid:i.sourcePid,range:i.range,productLine:i.productLine}),['buy','clkloc','clkRoute','appointment'].indexOf(e)>-1&&null!=t.avail&&(r.store={id:t.avail.store.id,name:t.avail.store.name,dlv:this._getDlvParam(t.avail.store),url:t.avail.store.url,location:{city:t.avail.store.location.city,zipCode:t.avail.store.location.zipCode,country:t.avail.store.location.country}},r.retailer={id:t.avail.retailer.id,name:t.avail.retailer.name},r.product&&(r.product.retailerPdtId=t.avail.product.retailerPdtId,r.product.price=t.avail.price.amount,r.product.currency=t.avail.price.currency)),'clktab'===e&&(r.tab=t.tab),'clkloc'===e&&(r.clklocType=t.clkloc_type),this.customTrackingOldNaming&&(r.compat=!0,r.resultCount&&(r.nbres=r.resultCount),r.product&&(r.prd={pid:r.product.id,ean:r.product.ean,pname:r.product.name,pname2:r.product.name2,ppckg:r.product.pkg,pbr:r.product.brand}),r.store&&r.product&&(r.store={pr:r.product.price,scity:r.store.location.city,szc:r.store.location.zipCode,country:r.store.location.country,rid:r.retailer.id,rname:r.retailer.name,rpid:r.product.retailerPdtId,sid:r.store.id,sname:r.store.name,dlv:r.store.dlv,surl:r.store.url}),r.loc={zipcode:r.location.zipCode},delete r.resultCount,delete r.product,delete r.retailer,delete r.location),r}_dropClientPixels(e){var t=this.trackingPixels[e.action];t&&(Array.isArray(t)||(t=[t]),t.forEach((t=>{this._urlRegExp.test(t)&&(t=this._replacePlaceholders(t,e,!0),app.withSafeFrame?this._addPixel(t):hostCom.send('awe:dropPixel',{url:t}))})))}_serverTracking(e,t){e.forEach((e=>{if('string'!=typeof e.value)return void console.log('Server custom tracking action defined but no value, please verify configuration in database');let a,r,i,s=!0;e.tracker&&this.consentMap&&this.consentMap.has(e.tracker)&&(a=this.consentMap.get(e.tracker),s=a.accepted),this._urlRegExp.test(e.value)?(i='url',r=this._replacePlaceholders(e.value,t,!0)):(i='script',r=this._replacePlaceholders(e.value,t,!1)),s?this._dropServerTracking({[i]:r}):a.queue.push({[i]:r})}))}_dropServerTracking(e){e.url?app.withSafeFrame?this._addPixel(e.url):hostCom.send('awe:dropPixel',e):e.script&&hostCom.send('awe:addScript',e)}_replacePlaceholders(e,t,a){return null==t||(this.customTrackingOldNaming?Object.entries(t).forEach((([t,r])=>{if('object'!=typeof r||Array.isArray(r)){let i=new RegExp(`{{${t}}}`,'g');e=e.replace(i,a?encodeURIComponent(r):r)}else e=this._replacePlaceholders(e,r,a)})):e=e.replace(/{{(.+?)}}/g,((e,r)=>{const i=r.split('.');let s=t;try{for(let e=0;e<i.length;e++)s=s[i[e]];return null==s?'':a?encodeURIComponent(s.toString()):s.toString()}catch(t){return e}}))),e}emptyQueue(){if(Tracker._queue){for(let e of Tracker._queue)Tracker._queue.delete(e),this._dropTag(e.action,e.params);delete Tracker._queue}}_flushDNT(e){for(e&&(this.session=e);this._dntQueue.length>0;){let{action:t,payload:a}=this._dntQueue.shift();a.flush=1,e&&(a=this._setSession(a)),this._immediateDropTag(t,a)}}_buildConsentMap(e){if(e&&e.actions){const t=new Map;return e.actions.forEach((e=>{e.consent&&e.tracker&&(t.has(e.tracker)||t.set(e.tracker,{accepted:!1,queue:[]}))})),t.size?t:null}}consentChange({tracker:e,consent:t}){const a=this.consentMap&&this.consentMap.get(e);if(!a){const t=`No data for tracker ${e} in consentMap`;return console.error(t),void Tracker.log('error',{msg:t})}if(a.accepted=!!t,a.accepted&&a.queue.length){for(let e of a.queue)this._dropServerTracking(e);a.queue=[]}}}Tracker.ready=!1;
//# sourceMappingURL=daco.js.map
