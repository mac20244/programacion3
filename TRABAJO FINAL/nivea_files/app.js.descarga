'use strict';const MIN_DISTANCE=500,LoaderType={PRODUCTS:'pdts',AVAILABILITIES:'avails',INIT:'init',AVAILS_NEXT:'avails-next'},ErrorCodes={AUTH_ERROR:'AUTH_ERROR',DISABLED_ERROR:'DISABLED_ERROR',INVALID_TOUCHPOINT_ERROR:'INVALID_TOUCHPOINT_ERROR',NO_EAN_ERROR:'NO_EAN_ERROR',NOPRODUCT_ERROR:'NOPRODUCT_ERROR',NOSTORE_ERROR:'NOSTORE_ERROR',PRODUCT_CONFIG_ERROR:'PRODUCT_CONFIG_ERROR',SERVER_ERROR:'SERVER_ERROR',UNAVAILABLE_COUNTRY_ERROR:'UNAVAILABLE_COUNTRY_ERROR'},ErrorLabels={AUTH_ERROR:'API authentication error',DISABLED_ERROR:'Disabled widget (API response 402)',INVALID_TOUCHPOINT_ERROR:'Touchpoint inconsistency between wtbConf and init params',NO_EAN_ERROR:'Eans/Range not provided (DCO is not enabled)',NOPRODUCT_ERROR:'API returned 0 products',NOSTORE_ERROR:'API returned 0 availabilities',PRODUCT_CONFIG_ERROR:'Provided EANS/range are invalid',SERVER_ERROR:'Server error',UNAVAILABLE_COUNTRY_ERROR:'Current country is not enabled'},OosLevels={NONE:0,ALLOW:1,INIT:2},OUTBOUND_SRC={BUY:'buy',CLKLOC:'clkloc',CUSTOM:'custom',FALLBACK:'fallback'},EAN_MIN_LENGTH=7,EAN_MAX_LENGTH=14,i18nUpdateMixin={methods:{forceUpdate:function(){this.$forceUpdate(),Object.values(this.$refs).forEach((t=>{t&&('function'==typeof t.forceUpdate?t.forceUpdate():'function'==typeof t.$forceUpdate&&t.$forceUpdate())}))}}},appDefinition={data:{_location:{address:'',city:'',zipCode:'',region:'',country:'',latitude:0,longitude:0,source:'',isEmpty:!0,boundingBox:null,auto:null,type:''},legacyCustomStyle:{},legacyCustomStyleValues:{},customStyleMapping:{},filteredProducts:[],products:[],productTotalCount:null,product:{name:'',name2:'',pkg:'',description:'',ratings:{}},productGroups:null,availabilities:[],onlineAvailabilities:[],onlineAndDriveAvailabilities:[],realAvailabilities:[],byTypologyAvailabilities:[],filteredAvailabilities:{all:[],online:[],real:[],byTypology:[]},availabilityGroups:null,availability:null,allEans:null,idType:null,wtbid:null,appId:null,locale:null,test:!1,baseLang:null,sizeMode:'adjust',fixedIframeHeight:!1,theme:null,templateLayout:'',wtbConf:{},i18n:null,defaultEan:null,availPrdOnly:null,showWarning:!0,alterUrl:null,fallbackStoreId:null,initDone:!1,defaultCountry:null,countries:[],filters:[],productFilters:{},isMedia:!1,hideHostScroll:!1,isPopin:null,showProductFilters:null,catalogSelector:!1,productSearchEnabled:!1,catalogFilters:null,useProductPagination:!1,mapVisible:!1,availRequestDone:!1,noCache:!1,layoutName:'',withSafeFrame:!1,pdtFilters:[],rtl:!1,presetPdtFilters:'',displayPrices:!1,lockdown:!1,lockdownNotifClosed:!1,geolocProvided:!1,firstOpeningDone:!1,isOpen:!1,allowOos:0,Utils:Utils,onlineOnly:!1,offlineOnly:!1,renderContext:void 0,draft:!1,delayGeoloc:!1,availSortOrder:null,retailerPriorities:null,dnt:!1,openFacets:[],isStoreLocator:!1,masterProductMode:!1,multiOffer:!1,error:'',customProps:{},tiedHouseThreshold:0,_rafid:null,_currentHeight:0,_trkData:{},_iframeSize:{width:-1,height:-1},_templateSelectionResults:{},_pendingProductReq:'',_lastProductReq:'',_availAborter:null,_pdtAborter:null,_intersectObserver:null,_trackedAvails:new Set,_availTrackItv:null,_resizeTimout:null,_widgetObserver:null,_backgroundVideo:null,_refParams:null},watch:{product:function(t,e){this.getAvailabilities(),this.trigger('product-select',{pdt:t})},products:function(){this.filteredProducts=this.products},location:function(t,e){this.location.isEmpty=!1},filteredProducts:function(t){if(t.length&&!t.find((t=>this.product.id===t.id))){let e;this.defaultEan&&this.defaultEan[this.country]&&(e=this.products.find(this.isDefaultProduct)),this.selectProduct(e||t[0])}},availabilities:function(t){let e=[],i=[],s=[],a=[];const o=new Set,r=new Set,n=new Map;for(let l=0;l<t.length;l++){const c=t[l],d=c.store.brick||c.store.collect||c.store.drive;if(this.multiOffer){const t=d?c.store.id:(c.store.typologyId||c.retailer.id)+c.product.ean;n.has(t)?n.get(t).push(c):n.set(t,[c])}d?this.multiOffer?n.get(c.store.id)[0]===c&&i.push(c):i.push(c):e.push(c);let h=(c.store.typologyId||c.retailer.id)+'/';this.multiOffer?h+=c.product.retailerPdtId:h+=c.product.id,o.has(h)||(s.push(c),o.add(h)),c.clkUrl&&!r.has(h)&&(a.push(c),r.add(h))}e=this.filterForTiedHouseLaw(e),i=this.filterForTiedHouseLaw(i),s=this.filterForTiedHouseLaw(s),a=this.filterForTiedHouseLaw(a),this.onlineAvailabilities=this.filteredAvailabilities.online=e,this.realAvailabilities=this.filteredAvailabilities.real=i,this.byTypologyAvailabilities=this.filteredAvailabilities.byTypology=s,a.sort(((t,e)=>Utils.compareOnline(t,e,this.availSortOrder,this.retailerPriorities))),this.onlineAndDriveAvailabilities=a,this.filteredAvailabilities.all=t,this.multiOffer&&(this.availabilityGroups=n),this.availability&&null==t.find((t=>t.store.id===this.availability.store.id))&&(this.availability=null,this.$refs.map&&this.$refs.map.clearSelection(),this.trigger('availability-select',{avail:null,area:Area.MAIN})),this.$nextTick().then((()=>{Tracker.log('avails-update',{count:this.availabilities.length}),this.availabilities.length&&this.trackVisibleStores()}))},rtl:function(t){t&&hostCom.send('awe:setRtl')},catalogFilters:function(){this.getProducts(!1,!1,!0)}},computed:{eans:function(){return this.allEans&&this.country&&this.allEans[this.country]?this.allEans[this.country]:[]},country:function(){return this.location?.country&&this.countries.includes(this.location.country)?this.location.country:this.defaultCountry},isRange:function(){return 1===this.eans.length&&24===this.eans[0].length},location:{get:function(){return this.$data._location},set:function(t){if(null!=t.auto&&''!==t.auto||console.log('no auto param on geoloc !'),this.countries.indexOf(t.country)>-1){let e=0,i=!1;this.location.isEmpty?this.error===ErrorCodes.UNAVAILABLE_COUNTRY_ERROR&&(e=501,i=!0):(e=Utils.getHaversineDistance(t,this.location),i=(t.country!=this.location.country||this.availPrdOnly)&&'api-avail'!==t.source),this.$data._location=t,this.error===ErrorCodes.UNAVAILABLE_COUNTRY_ERROR&&(this.error=''),e>500&&(i?this.getProducts(this.eans):'api-avail'!==t.source&&this.getAvailabilities()),t.source.startsWith('api-')||hostCom.send('awe:saveLocation',{loc:t}),this.trigger('location-update',{location:t})}else t.auto||null==t.auto&&'manual'!=t.source||(console.warn(`'${t.country}' is out of scope.`),(this.allowOos&OosLevels.ALLOW)===OosLevels.ALLOW&&(this.$data._location=t,this.availabilities=[],this.trigger('location-update',{location:t}),this.trigger('availabilities-update',{avails:[]}),hostCom.send('awe:saveLocation',{loc:t})),this.raiseError(ErrorCodes.UNAVAILABLE_COUNTRY_ERROR))}},langs:function(){return this.locale===this.baseLang?this.locale:this.locale+' '+this.baseLang},productTotal:function(){return this.productTotalCount}},created:function(){window.i18n=this.i18n=new I18n(this),hostCom.on('awe:open',(t=>{if(this.isOpen=!0,this.initDone)return this.open(t.params);let e=setInterval((()=>{this.initDone&&(clearInterval(e),this.open(t.params))}),50)})),hostCom.on('awe:close',(t=>{this.isOpen=!1}))},updated:async function(){'adjust'!==this.sizeMode||window.ResizeObserver||this.checkHeight()},directives:{'resize-map':{componentUpdated:function(){setTimeout(app.$refs.map.resize,50)}}},mixins:[i18nUpdateMixin],methods:{init:async function(t,e){performance.measure('appinit','app-start'),this.wtbConf=e,this.locale=this.i18n.setLang(t.locales),this.baseLang=this.i18n.baseLang,this.dnt=t.dnt,e.glassbox&&(t.glassbox?this.injectGlassbox(t.glassbox.sessionId,t.glassbox.reportURI,e.glassbox):hostCom.send('awe:glassbox',(t=>{t.enabled&&this.injectGlassbox(t.sessionId,t.reportURI,e.glassbox)}))),this.wtbConf.enableremoteconf&&this.wtbConf.widgetclientparams&&this.injectCustomStyle(this.wtbConf.widgetclientparams.params),t.embeddedBtn&&this.locale!==t.locales[0]&&this.updateLocale(this.locale,t.locales[0],this.i18n.baseLang,t.locales[0]&&t.locales[0].split('-')[0]),this.locale!==t.locales[0]&&t.localesConf[this.locale]?.iframeTitle&&hostCom.send('awe:updateTitle',{newTitle:t.localesConf[this.locale].iframeTitle});const i=t.localesConf?.[this.locale]?.iframeTitle||t.title;if(this.$el.setAttribute('aria-label',i),t.wtbid&&(this.wtbid=t.wtbid),(t.appid||t.appId)&&(this.appId=t.appid||t.appId),t.templateLayout&&(this.templateLayout=t.templateLayout),t.productSearchEnabled&&(this.productSearchEnabled=!0),t.catalogSelector?this.catalogSelector=!0:t.eans&&(null==this.allEans?this.allEans=t.eans:this.allEans=Object.assign({},t.eans,this.allEans)),t.defaultEan&&(this.defaultEan=t.defaultEan),this.idType=t.idType,this.masterProductMode=!!t.masterProductMode,this.multiOffer=!!t.multiOffer,this.theme=t.theme||'',this.availPrdOnly=!!t.availPrdOnly,this.addNearestOnDelivery=!!t.addNearestOnDelivery,this.isPopin=!t.containerId,t.width&&t.height?(this.sizeMode='fixed',this.setRootSize({width:t.width,height:t.height})):t.freeSize||this.isPopin?this.sizeMode='free':this.monitorHeight(),this.fixedIframeHeight='adjust'!==this.sizeMode,this.showProductFilters=!!t.showProductFilters,this.defaultCountry=t.defaultCountry,this.countries=t.enabledCountries,this.displayPrices=!!e.displayprices||!(!e.enableremoteconf||!e.widgetclientparams?.params?.['show-prices']),this.onlineOnly=!!t.onlineOnly,this.offlineOnly=!!t.offlineOnly,this.isStoreLocator=e.isStoreLocator,this.test=e.test||t.test||/test=(1|true)/i.test(t.referrer2),this.openFacets=t.openFacets||[],this.renderContext=t.renderContext||void 0,this.draft=!!t.draft,this.delayGeoloc=!!t.delayGeolocation,'studio'===this.renderContext&&(this.$data._refParams||(this.$data._refParams=t),hostCom.hasKey('awe:style-update')||hostCom.on('awe:style-update',(t=>{this.$data._refParams&&this.init({...this.$data._refParams,locales:[this.wtbConf.widgetclientparams.params.locale],theme:t.params.theme},{...this.wtbConf,widgetclientparams:{params:t.params}})}))),this.noCache=/nocache=(1|true)/i.test(t.referrer2)||this.draft||!!this.renderContext,(this.draft||this.renderContext)&&(this.showWarning=!1),t.geoloc)if(this.geolocProvided=!0,t.geoloc.zipCode&&t.geoloc.address&&t.geoloc.country&&t.geoloc.city)this.$data._location=t.geoloc;else{const e=t.geoloc.country?[t.geoloc.country]:this.countries,i=await Utils.getReverseGeocoding(t.geoloc.longitude,t.geoloc.latitude,e,this.locale,'init');i?this.$data._location=i:t.location&&(this.$data._location=t.location,this.geolocProvided=!1)}else t.location&&(this.$data._location=t.location);if(null!=t.media&&(this.isMedia=!!t.media),t.touchpoint&&t.touchpoint!==this.wtbConf.touchPoint)return void this.raiseError(ErrorCodes.INVALID_TOUCHPOINT_ERROR);t.layout&&(this.layoutName=t.layout),this.withSafeFrame=!!t.withSafeFrame,this.tracker=new Tracker(t,this.wtbConf,t.perf.loader+t.perf.switch),null==e.geoCountry&&(console.log('geocountry is null'),Tracker.log('geocountry_null',{})),null==app.country&&(console.log('app.country is null'),Tracker.log('country_null',{defaultCountry:this.defaultCountry,locCountry:this.location.country})),this.isPopin&&document.body.addEventListener('keyup',(t=>{'Escape'===t.key&&'INPUT'!==t.target.nodeName&&this.closeWidget(t)})),this.$refs.map&&(this.$refs.map.startVisible||t.modeStoreLocator)&&this.showMap(null,!1,!0),this.alterUrl=t.alterUrlEnabled&&t.alterUrl,this.hideHostScroll=!!t.hideHostScroll,this.pdtFilters=Mapping.mapPdtFilters(e.prdFilters),this.presetPdtFilters=t.presetPdtFilters,this.allowOos=t.allowOos,this.useProductPagination=!!t.productPagination,this.allowOos>OosLevels.ALLOW&&(this.allowOos=this.allowOos|OosLevels.ALLOW),this.availSortOrder=Symbol.for(e.retcfg&&e.retcfg.onlineStoresOrder||0),this.availSortOrder===AVAIL_SORT_ORDER.DEFAULT&&e.retcfg?.priorities?.length&&(this.availSortOrder=AVAIL_SORT_ORDER.PRIO_LIST,this.retailerPriorities=e.retcfg.priorities),this.initDone=!0,!this.isMedia&&window.IntersectionObserver&&(this.$data._widgetObserver=new IntersectionObserver((([t],e)=>{t.isIntersecting&&t.intersectionRect.height>=30&&(Tracker.dropTag('visible'),e.disconnect(),this.$data._widgetObserver=null)}),{root:null,rootMargin:'0px',threshold:[.01,.02,.04,.06,.08,.1,.12,.15,.2,.4]})),this.trigger('app-init',{locale:this.locale,params:t,wtbConf:this.wtbConf});const s=performance.getEntriesByName('appinit','measure')[0].duration,a={loadTime:(t.perf.loader+t.perf.switch+s).toFixed(0),cpus:navigator.hardwareConcurrency,intersectionObs:+!!window.IntersectionObserver,perf_appInit:s.toFixed(0)};null!=navigator.deviceMemory&&(a.memory=navigator.deviceMemory),Object.entries(t.perf).forEach((([t,e])=>{e&&(a[`perf_${t}`]=e.toFixed(0))})),console.debug(Object.entries(a).map((([t,e])=>`${t}:${e}${t.startsWith('perf_')?'ms':''}`)).join('   ')),Tracker.log('initMetrics',a)},open:function(t){let e=!1,i=!1;if(t.idType&&(this.idType=t.idType),this.tracker.openerIdx=t.openerIdx,t.theme&&(this.theme=t.theme),t.eans){const i=this.eans;this.allEans=Object.assign({},this.allEans,t.eans),e=!Utils.arraysEqual(i,this.eans)}if(t.trackdploy&&Tracker.dropTag('dploy',t.trackdploy),t.defaultEan){const e=this.defaultEan&&this.defaultEan[this.country];this.isDefaultProduct(this.product);this.defaultEan=Object.assign({},this.defaultEan,t.defaultEan),i=e!=this.defaultEan[this.country]}if(!this.countries.includes(this.country))return this.raiseError(ErrorCodes.UNAVAILABLE_COUNTRY_ERROR),this.products=[],this.availabilities=[],void(this.location.isEmpty&&this.setDefaultAddress());const s=this.isMedia&&this.wtbConf.isDco;if(!(0!==this.eans.length||s||this.catalogSelector||this.useProductPagination))return this.raiseError(ErrorCodes.NO_EAN_ERROR),console.warn(`Missing range/eans for country ${this.country}.`),this.products=[],void(this.availabilities=[]);if(e&&this.$refs.errMon.clear(),this.eans.length>0){const t=this.idType?t=>!!t:t=>t.length>=7&&t.length<=14||this.isRange;if(!this.eans.some(t))return this.raiseError(ErrorCodes.PRODUCT_CONFIG_ERROR),console.warn(`Missing or invalid range/eans: '${this.eans}' for country ${this.country}.`),this.products=[],void(this.availabilities=[]);e&&this.$refs.errMon.clear()}if(!this.firstOpeningDone||e)this.getProducts(this.eans,!1,i);else if(t.defaultEan){const t=this.products.find(this.isDefaultProduct);t&&(this.selectProduct(t,!0),this.$refs.slider&&this.$refs.slider.init())}this.firstOpeningDone||'manual'===this.location.source||this.isMedia||this.geolocProvided||this.delayGeoloc||this.autoloc(),t.isOpen||this.trigger('widget-open'),e&&this.$emit('scope-update',{eans:this.eans}),this.hideHostScroll&&this.isPopin&&hostCom.send('awe:hideScroll'),this.firstOpeningDone=!0,this.$data._widgetObserver&&setTimeout((()=>{this.$data._widgetObserver&&this.$data._widgetObserver.observe(this.$el)}),400),this.isPopin&&setTimeout((()=>{const t=['.product-slider','.product-dropdown','input[type="text"]','#close','.carousel','input'];let e,i=0;do{e=document.querySelector(t[i])}while(++i<t.length&&!e);e&&e.focus()}),400)},getProducts:function(t,e,i){return this.useProductPagination?this.getPaginatedProducts(0,null,e,i,0):this._getProducts(t,e,i)},_getProducts:async function(t,e=!1,i=!1){if((!t||0===t.length||1===t.length&&/^0+$/.test(t[0]))&&!this.isMedia&&!this.useProductPagination)return;if(!this.countries.includes(this.country))return;let s;try{if(s=`https://wtb-api-hub.swaven.com/wtb/v2/api/search/products/${t}?wtbid=${this.wtbid}&lang=${this.locale}&av=${this.availPrdOnly}&country=${this.country}`,e||this.location.isEmpty||(s+=`&lat=${this.location.latitude}&lng=${this.location.longitude}&addr=${this.location.address}&city=${this.location.city}&zc=${this.location.zipCode}&cc=${this.location.country}&placetype=${this.location.type}&state=${this.location.region}`),this.draft&&(s+='&draft=1'),this.idType&&(s+=`&idtype=${this.idType}`),s=encodeURI(s),s===this.$data._pendingProductReq||s===this.$data._lastProductReq)return;this.$data._pendingProductReq=s,this.$data._pdtAborter&&this.$data._pdtAborter.abort(),this.$data._pdtAborter=new AbortController,this.showLoader(LoaderType.PRODUCTS);const a=await fetch(s,{credentials:'include',signal:this.$data._pdtAborter.signal});if(this.$data._pendingProductReq='',this.$data._pdtAborter=null,200!=a.status)return void this.raiseError(a.status);const o=await a.json();if(o&&0===o.p.length){this.availabilities=[],this.raiseError(ErrorCodes.NOPRODUCT_ERROR);let t={av:+this.availPrdOnly,forceloc:+e};return e||this.location.isEmpty||(t=Object.assign(t,this.location),delete t.auto),void Tracker.dropTag('nopdt',t)}this.$data._lastProductReq=s,o.loc&&this.useApiLocation(o.loc,e),o.tags&&this.showProductFilters&&(this.productFilters=o.tags);let r=Mapping.mapProducts(o.p).map((t=>Utils.sanitizeProduct(t)));if(this.masterProductMode){const{masters:t,groups:e}=this.getMasterProducts(r);r=t,this.productGroups=e}this.products=r,this.updateProductSelection(i),this.trigger('products-update',{products:Utils.clone(this.products),defaultId:this.product.id}),this.error=''}catch(t){'AbortError'!==t.name&&(this.$data._pdtAborter=null,this.$data._pendingProductReq='',this.raiseError(ErrorCodes.SERVER_ERROR,t),Tracker.log('error',{msg:t.message,stack:t.stack,source:'api-pdt'}))}finally{this.hideLoader(LoaderType.PRODUCTS);const t=performance.getEntriesByName(s)[0];t&&Tracker.log('api-pdt',{pdtReqTime:Math.round(t.duration)})}},getNextProductPage:function(t){if(console.log('getNextProductPage',t),this.products.length<this.productTotalCount)return this.getPaginatedProducts(this.products.length,null,!1,!1)},filtersUpdateHandler:function(t){try{this.catalogFilters=t.filter((t=>t[1].length)).map((t=>`"${encodeURIComponent(t[0])}":[${t[1].map((t=>'"'+encodeURIComponent(t)+'"')).join(',')}]`)).join(',')}catch(t){Tracker.log('error',{msg:'invalid filters provided',stack:t.stack})}},getPaginatedProducts:async function(t,e,i,s){if(!this.countries.includes(this.country))return;let a;try{if(isNaN(t)&&(t=0),isNaN(e)&&(e=10),a=`https://wtb-api-hub.swaven.com/wtb/v2/api/search/products?wtbid=${this.wtbid}&lang=${this.locale}&av=${this.availPrdOnly}&country=${this.country}&offset=${t}`,this.catalogFilters&&(a+=`&filters={${this.catalogFilters}}`),i||this.location.isEmpty||(a+=`&lat=${encodeURIComponent(this.location.latitude)}&lng=${encodeURIComponent(this.location.longitude)}&addr=${encodeURIComponent(this.location.address)}&city=${encodeURIComponent(this.location.city)}&zc=${encodeURIComponent(this.location.zipCode)}&cc=${this.location.country}&placetype=${this.location.type}&state=${this.location.region}`),this.draft&&(a+='&draft=1'),a===this.$data._pendingProductReq||a===this.$data._lastProductReq)return;this.$data._pendingProductReq=a,this.$data._pdtAborter&&this.$data._pdtAborter.abort(),this.$data._pdtAborter=new AbortController,this.showLoader(LoaderType.PRODUCTS);const o=await fetch(a,{credentials:'include',signal:this.$data._pdtAborter.signal});if(this.$data._pendingProductReq='',this.$data._pdtAborter=null,200!=o.status)return void this.raiseError(o.status);const r=await o.json();if(r&&0===r.products.length)return;this.$data._lastProductReq=a,r.loc&&this.useApiLocation(r.loc,i),r.tags&&this.showProductFilters&&(this.productFilters=r.tags);const n=Mapping.mapProducts(r.products).map((t=>Utils.sanitizeProduct(t)));this.products=0===t?n:this.products.concat(n),this.productTotalCount=r.total,0===t&&this.updateProductSelection(s),this.trigger('products-update',{products:Utils.clone(this.products),defaultId:this.product.id}),this.error=''}catch(t){'AbortError'!==t.name&&(this.$data._pdtAborter=null,this.$data._pendingProductReq='',this.raiseError(ErrorCodes.SERVER_ERROR,t),Tracker.log('error',{msg:t.message,stack:t.stack,source:'api-pdt'}))}finally{this.hideLoader(LoaderType.PRODUCTS);const t=performance.getEntriesByName(a)[0];t&&Tracker.log('api-pdt',{pdtReqTime:Math.round(t.duration)})}},updateProductSelection:function(t){let e;t||(e=this.product.id&&this.products.find((t=>t.id===this.product.id))),!e&&this.defaultEan?.[this.country]&&(e=this.products.find(this.isDefaultProduct)),this.selectProduct(e||this.products[0],!0)},useApiLocation:function(t,e){(e||0===this.location.latitude&&0===this.location.longitude)&&(t.auto=!0,this.location=Mapping.mapLocation(t,'api-pdt')),null!=t.RegionIsMetric&&(this.i18n.isMetric=!!t.RegionIsMetric)},getAvailabilities:async function(){if(!this.product.ean||!this.countries.includes(this.country))return;this.$data._availAborter&&(this.$data._availAborter.abort(),await new Promise((t=>setTimeout(t,0)))),this.$data._availAborter=new AbortController;let t,e=this.product.ean;this.masterProductMode&&(e=this.productGroups.get(this.product)?.map((t=>t.ean)).join(','));try{this.showLoader(LoaderType.AVAILABILITIES),t=encodeURI(`https://wtb-api-hub.swaven.com/wtb/v2/api/search/${this.isStoreLocator?'storelocator/':''}availabilities/${e}?wtbid=${this.wtbid}&lang=${this.locale}&lat=${this.location.latitude}&lng=${this.location.longitude}&zc=${this.location.zipCode}&addr=${this.location.address}&cc=${this.location.country}&country=${this.country}&placetype=${this.location.type}&state=${this.location.region}`),this.multiOffer&&(t+='&multioffers=1'),this.draft&&(t+='&draft=1');const i=await fetch(t,{credentials:'include',signal:this.$data._availAborter.signal});if(200!=i.status)return void this.raiseError(i.status);const s=await i.json();this.tiedHouseThreshold=s.tiedHouseLaw;const a=Mapping.mapAvailabilities(s.d,{PAGEID:this.tracker.pageId,IID:window.name,SID:this.tracker.session&&this.tracker.session.id,SURL:this.tracker.session&&this.tracker.session.url,SRFR:this.tracker.session&&this.tracker.session.referrer,RFR:this.tracker.rfr,RFR2:this.tracker.rfr2});this.addNearestOnDelivery&&a.forEach((t=>{if(t.store.homeDelivery&&0==t.store.location.latitude&&0==t.store.location.longitude){let e=a.find((e=>e.retailer.id===t.retailer.id&&e.store.location.latitude&&e.store.location.longitude));e&&(t.nearestStore=e.store)}}));let o=a;if(!this.multiOffer){const t=new Set;o=o.filter(((e,i)=>{const s=e.store.id+e.product.ean,a=t.has(s);return a||t.add(s),!a}))}o=this.filterForTiedHouseLaw(o),this.availabilities=o,this.$nextTick((()=>{this.trigger('availabilities-update',{avails:this.availabilities})}));let r=s.next&&s.next.length;if(r?this.getOtherRetailers(s.next,a):this.$data._availAborter=null,this.lockdown=!!s.lockdown,this.$data._trkData.avgpc=s.avgp,this.$data._trkData.avgdst=s.avgdst,this.$data._trkData.nbres=s.nbres,this.$data._trkData.nbrefret=s.nbrefret,this.tracker.availReqId=Utils.uuid(),Tracker.dropTag('apires'),0===this.availabilities.length&&!r)return void this.raiseError(ErrorCodes.NOSTORE_ERROR);s.loc&&this.location.isEmpty&&(s.loc.auto=!0,this.location=Mapping.mapLocation(s.loc,'api-avail')),s.usids&&s.usids.length>0&&Tracker.dropTag('unavlbsids',{sids:s.usids.slice(0,20)}),this.fallbackStoreId=s.dsid;let n=this.realAvailabilities.filter((t=>0==t.store.location.latitude&&0==t.store.location.longitude)).map((t=>`\t${t.retailer.name} (${t.retailer.id}) ${t.store.name} (${t.store.id})`));n.length&&console.info(`These stores have no geolocation data:\n${n.join('\n')}`),this.error=''}catch(t){'AbortError'!==t.name&&(this.$data._availAborter=null,this.raiseError(ErrorCodes.SERVER_ERROR,t),Tracker.log('error',{msg:t.message,stack:t.stack,source:'api-avails'}))}finally{if(this.isMedia){const t=this.$refs['loader-'+LoaderType.INIT];t&&t.visible&&(this.hideLoader(LoaderType.INIT),performance.measure('widget-loader-time','widget-loader-start'),Tracker.dropTag('hideWidgetLoader',{duration:Utils.getPerf('widget-loader-time')}))}this.hideLoader(LoaderType.AVAILABILITIES),this.availRequestDone=!0;const e=performance.getEntriesByName(t)[0];e&&Tracker.log('api-avails',{availReqTime:Math.round(e.duration)})}},getOtherRetailers:async function(t,e){const i=new Array(t.length);this.showLoader(LoaderType.AVAILS_NEXT,0);for(let s=0;s<t.length;s++){const a=t[s],o=new Promise((async t=>{try{const i=await fetch(a,{credentials:'include',signal:this.$data._availAborter.signal}),s=await i.json(),o=Mapping.mapAvailabilities(s,{PAGEID:this.tracker.pageId,IID:window.name,SID:this.tracker.session&&this.tracker.session.id,SURL:this.tracker.session&&this.tracker.session.url,SRFR:this.tracker.session&&this.tracker.session.referrer,RFR:this.tracker.rfr,RFR2:this.tracker.rfr2});o.length&&(this.availabilities=Utils.mergeAvailLists(this.availabilities,o,this.availSortOrder,this.retailerPriorities),this.updateTrackingData(),e=Utils.mergeAvailLists(e,o,this.availSortOrder,this.retailerPriorities)),t()}catch(e){'AbortError'!==e.name&&(console.error(e),Tracker.log('error',{msg:e.message,stack:e.stack,source:'api-avails'})),t()}}));i.push(o)}return await Promise.all(i),this.availabilities=this.filterForTiedHouseLaw(e),this.updateTrackingData(),this.$data._availAborter=null,this.hideLoader(LoaderType.AVAILS_NEXT),0===this.availabilities.length&&this.raiseError(ErrorCodes.NOSTORE_ERROR),Promise.resolve()},filterForTiedHouseLaw:function(t=[]){if(!this.tiedHouseThreshold)return t;const e=this._filterForUniqueRetailers(t,(t=>t.retailer.isTiedHouseLaw)).length;if(!e)return t;const i=e>=this.tiedHouseThreshold;return t.filter((({retailer:t={}})=>!t.isTiedHouseLaw||i))},_filterForUniqueRetailers:function(t=[],e){const i=[];return t.filter((t=>{const s=t.store.typologyId||t.retailer.id;return!(i.includes(s)||e&&!e(t))&&(i.push(s),!0)}))},getMasterProducts:function(t,e='name',i){const s=new Map,a=new Map;return{masters:t.filter((t=>{const o=i?i(t[e]):t[e],r=s.get(o);return r?a.get(r).push(t):(s.set(o,t),a.set(t,[t])),!r})),groups:a}},redirect:function(t,e){t.stopPropagation(),t.preventDefault();switch(t.currentTarget.dataset.redirectMode){case'map':window.open(e.store.gmapUrl),Tracker.dropTag('clkloc',{avail:e,outbound:!0,auto:!1}),this.isMedia&&this.tracker.dropClicktag(OUTBOUND_SRC.CLKLOC);break;case'phone':window.open(`tel:${e.store.phone}`),Tracker.dropTag('clkloc',{avail:e,auto:!1,clkloc_type:'tel'});break;case'whatsapp':window.open(`https://api.whatsapp.com/send?phone=${e.store.whatsapp}&text=${encodeURIComponent(this.customProps.whatsappMessage)}`),Tracker.dropTag('clkloc',{avail:e,auto:!1,clkloc_type:'whatsapp'});break;case'appointment':window.open(e.store.appointmentUrl),Tracker.dropTag('clkloc',{avail:e,auto:!1,clkloc_type:'appointment'});break;case'retailerHome':window.open(e.store.url||e.retailer.url),Tracker.dropTag('clkloc',{avail:e,auto:!1,clkloc_type:'retailerHome'});break;default:this.buy(e,t)}},setLocation:function(t){this.location=t,Tracker.dropTag('geoloc')},showMap:function(t,e=!1,i=!1,s){if(s&&s.stopPropagation(),t&&!this.hasPosition(t))return;this.mapVisible=!0;const a=t&&(null==this.availability||this.availability.store.id!==t.store.id);t&&(this.availability=t,this.trigger('availability-select',{avail:t,area:Area.MAIN})),setTimeout((()=>{this.$refs.map.show(Utils.clone(t),e)}),100),t?a&&Tracker.dropTag('clkloc',{avail:t,area:Area.MAIN}):Tracker.dropTag('showmap',{area:Area.MAIN,auto:i}),this.trigger('map-show')},closeMap:function(){this.mapVisible=!1,this.trigger('map-close')},buy:function(t,e,i=!1){if(e.stopPropagation(),e.preventDefault(),Tracker.dropTag('buy',{avail:t,leadid:t.leadid,outbound:!0}),i||(this.trigger('product-buy',{avail:t,leadid:t.leadid}),window.open(t.clkUrl||t.store.url||t.retailer.url)),this.isMedia&&this.tracker.dropClicktag(OUTBOUND_SRC.BUY),t)this.getNewLeadid(t);else{let i;null===t?i='null':void 0===t?i='undefined':!1===t?i='false':0===t?i='0':''===t?i='empty string':isNaN(t)&&(i='NaN');const s=[];for(let t=0;t<e.currentTarget.attributes.length;t++)s.push({k:e.currentTarget.attributes[t].name,v:e.currentTarget.attributes[t].value});Tracker.log('error',{msg:'Buy avail is '+i,avails:this.availabilities.map((t=>t?t.store.id:'null')),target:`<${e.currentTarget.nodeName} ${s.map((t=>`${t.k}="${t.v}"`)).join(' ')}>`})}},getNewLeadid:function(t){if(!t){try{throw new Error('avail is undefined')}catch(t){const e=t.stack.substring(0,512);Tracker.log('error',{stack:e})}return}const e=t.leadid;if(t.leadid=Utils.uuid().replace(/-/g,''),t.clkUrl=t.rawClkUrl.replace('{SWN-LEADID}',t.leadid),this.$refs.map&&!this.$refs.map.selected?.isDefault&&t!==this.$refs.map.selected){const e=Utils.clone(this.$refs.map.selected);e.leadid=t.leadid,e.clkUrl=t.clkUrl,this.$refs.map.selected=e}else if(t===this.$refs.map?.selected&&t!==this.availability){const i=this.availabilities.find((t=>t.leadid===e));i.leadid=t.leadid,i.clkUrl=t.clkUrl}},selectProduct:function(t,e=!1){const i=this.product?.id!==t?.id;this.product=t,i&&Tracker.dropTag('clk',{auto:e,autoSel:1===this.eans.length&&!this.isRange})},setEans:function(t,e=!1){const{eans:i,defaultEan:s}=t;this.allEans?this.allEans={...this.allEans,[this.country]:i}:this.allEans={[this.country]:i},s&&(this.defaultEan?this.defaultEan[this.country]=s:this.defaultEan={[this.country]:s}),this.getProducts(this.eans,!1,!0)},updateAutocomplete:function(t){if(document.activeElement===t.currentTarget){const e=t.currentTarget.value;this.$refs.autocomplete.request(e)}},getDirections:function(t){this.$refs.map.getDirections()},autoloc:function(t){const e=!t;hostCom.send('awe:getLocation',{auto:e},(async t=>{if(t.lng&&t.lat){const i=await Utils.getReverseGeocoding(t.lng,t.lat,[],this.language,'html5',e);i?this.location=i:await this.getProducts(this.eans,!0)}else await this.getProducts(this.eans,!0);e||Tracker.dropTag('geoloc')}))},getTrkData:function(){return this.$data._trkData},getStoreIds:function(){return this.availabilities.slice(0,20).map((t=>t.store.id))},getLocation:function(){return Utils.clone(this.location)},closeWidget:function(t=!1){if(t.repeat)return;let e=!!t;t instanceof Event&&(e=!1,t.stopPropagation()),Tracker.dropTag('close',{auto:e}),hostCom.send('awe:close')},trigger:function(t,e={}){let i=new CustomEvent(t,{detail:e,bubbles:!0});this.$el&&this.$el.dispatchEvent(i)},addEventListener:function(t,e,i=!1){this.$el.addEventListener(t,e,i)},removeEventListener:function(t,e,i=!1){this.$el.removeEventListener(t,e,i)},checkHeight:async function(){await this.$nextTick();let t=null,e=null;const i=s=>{if(t||(t=e=s),s-e>=100){const t=Math.ceil(window['app-ctnr'].getBoundingClientRect().height);t!=this.$data._currentHeight&&(hostCom.send('awe:resize',{height:t}),this.$data._currentHeight=t),e=s}s-t<1e3?this._rafid=window.requestAnimationFrame(i):window.cancelAnimationFrame(this._rafid)};window.cancelAnimationFrame(this._rafid),this._rafid=window.requestAnimationFrame(i)},resizeWindow:function(){null==this.$data._resizeTimout&&(this.$data._resizeTimout=setTimeout((()=>{this.checkHeight(),this.$data._resizeTimout=null}),100))},raiseError:function(t,e){if('number'==typeof t)switch(t){case 401:case 403:t=ErrorCodes.AUTH_ERROR;break;case 402:t=ErrorCodes.DISABLED_ERROR;break;default:t=ErrorCodes.SERVER_ERROR}[ErrorCodes.AUTH_ERROR,ErrorCodes.DISABLED_ERROR,ErrorCodes.INVALID_TOUCHPOINT_ERROR,ErrorCodes.NO_EAN_ERROR,ErrorCodes.SERVER_ERROR].includes(t)||t===ErrorCodes.PRODUCT_CONFIG_ERROR&&!this.wtbConf.multiCountry?(this.availabilities=[],this.$refs.errMon.show(t)):this.error=t,this.trigger('error',{msg:t,err:e});let i=`${t}: ${ErrorLabels[t]}`;e&&(e.message&&(i+='\n'+e.message),e.stack&&(i+='\n'+e.stack)),console.error(i)},showLoader:function(t,e){var i='loader-'+t,s=this.$refs[i]||this.$refs.loader;s&&s.show(e),this.trigger('loader-show',{type:t,delay:e})},hideLoader:function(t){var e='loader-'+t,i=this.$refs[e]||this.$refs.loader;i&&i.hide(),this.trigger('loader-hide',{type:t})},hasPosition:function(t){return!(!t||!(t.store.location.latitude&&t.store.location.longitude||t.nearestStore))},setAvailability:function(t){this.availability=t.avail,this.trigger('availability-select',{avail:this.availability})},hasOpeningTimes:function(t){const e=t&&(t.nearestStore||t.store);return!!e&&(3===e.openingType&&e.openingHours)},getIframeSize:function(t=!1){return new Promise((e=>{hostCom.send('awe:getSize',{useContainer:t},(t=>{this.$data._iframeSize={width:t.width,height:t.height},e()}))}))},setRootSize:function(t){this.$el.style.width=t.width+'px',this.$el.style.height=t.height+'px'},injectCustomStyle:function(t){this.injectLegacyCustomStyle(t);const{rules:e,fontImports:i,fontFaces:s}=this._buildCustomStyle(t);if(e.size>0||t['custom-css']||i.length>0||s.length>0){const a=this._serializeCustomStyle(e,i,s,t['custom-css']),o=document.getElementById('custom-style');if(o)o.innerHTML=a;else{const t=document.createElement('style');t.innerHTML=a,t.id='custom-style',document.body.appendChild(t)}}},_buildCustomStyle(t){const e=new Map,i=[],s=[];return Object.entries(t).forEach((([t,a])=>{if(!this.customStyleMapping[t])return;if(''===a||null==a)return;let o,r,n=!1;if([o,r]=this.customStyleMapping[t],r=r||'#app-ctnr',t.includes('color'))/^([0-9a-fA-F]{3}){1,2}$/.test(a)?a='#'+a:a.startsWith('--')&&(a=`var(${a})`);else if('background-image'===t)if(a.startsWith('http')){if(/\.(webm|mp4)$/i.test(a))return void(this.$data._backgroundVideo=a);this.$data._backgroundVideo=null,a=`url("${a}")`}else a.includes('gradient')||(o='--main-bg');else t.startsWith('font-')&&(n=!0,Utils.parseFont(t,a,i,s));if(!n){const t=`${o}:${a};`,i=e.get(r);i?i.push(t):e.set(r,[t])}})),t['custom-font']&&Utils.parseFont('font-default',t['custom-font'],i,s),{rules:e,fontImports:i,fontFaces:s}},_serializeCustomStyle(t,e,i,s){let a='',o='';e.forEach((t=>{a+=t.rule+'\n',o+=Utils.setFontVariable(t.optionName,t.fontName)})),s&&(a+=s),i.forEach((t=>{a+=t.rule+'\n',o+=Utils.setFontVariable(t.optionName,t.fontName)})),o&&(a+=`#app-ctnr{ ${o} }`);for(const[e,i]of t)a+=`${e}{ ${i.join('')} }\n`;return a},injectLegacyCustomStyle:function(t){if(0===Object.keys(app.legacyCustomStyle).length)return;const e={},i=/'[^']+?'([^\s]?)+|\S+/g;if(Object.keys(app.legacyCustomStyle).forEach((s=>{t[s]&&app.legacyCustomStyle[s].match(i).forEach((i=>{if(!i)return;let[a,o]=i.split('/'),r=t[s];a=a.replace(/'/g,''),o=o?o.replace(/'/g,''):app.legacyCustomStyleValues[s],e[a]||(e[a]=''),(o.includes('color')||'background'===o)&&(r=Utils.prependColor(r)),'font-src'===o?e['@font-face']=`font-family: '${t['global-font-family']}'; src:url('${r}');`:e[a]+=`\t${o}: ${r} !important;\n`}))})),Object.keys(e).length){let t=Object.entries(e).map((([t,e])=>`${t}{${e}}`)).join('\n'),i=document.createElement('style');i.innerHTML=t,i.id='legacy-custom-style',document.body.appendChild(i)}},dropTag:function(t,e,...i){if(t.stopPropagation(),'clicktag'===e&&this.isMedia)return void this.tracker.dropClicktag(i&&i[0]||OUTBOUND_SRC.CUSTOM);const s={};switch(e){case'clkloc':s.auto=!!i[1]?.auto,s.outbound=!!i[1]?.outbound,s.clkloc_type=i[1]?.clkloc_type||null;case'appointment':s.avail=i[0],s.area=Area.MAIN;break;case'clknav':case'mover':s.area=Area.MAIN;break;case'custredirect':s.auto=!!i[0]&&!!i[0].auto,s.outbound=!i[0]||null==i[0].outbound||!!i[0].outbound;break;default:s.unknown=!0}s.unknown||Tracker.dropTag(e,s)},trackVisibleStores:function(){if('undefined'==typeof IntersectionObserver)return;this._intersectObserver?this._intersectObserver.disconnect():this._intersectObserver=new IntersectionObserver(this.visibleStoreHandler,{root:null,rootMargin:'0px',threshold:.5});const t=document.getElementsByClassName('_avail');for(let e=0;e<t.length;e++)this._intersectObserver.observe(t[e]);Tracker.log('observeStores',{nodesCount:t.length}),setTimeout(this._checkSeenStores,200),clearInterval(this.$data._availTrackItv),this.$data._availTrackItv=setInterval(this._checkSeenStores,1500);const e=new WeakMap;setInterval((()=>{const i=document.documentElement.clientHeight,s=document.documentElement.clientWidth,a=[];for(let o=0;o<t.length;o++){const r=t[o],n=r.getBoundingClientRect(),l=n.width*n.height;let c=0;n.top<0&&(c+=Math.abs(n.top)*n.width),n.bottom>i&&(c+=(n.bottom-i)*n.width),n.left<0&&(c+=Math.abs(n.left)*n.height),n.right>s&&(c+=(n.right-s)*n.height);c/l<=.5&&!e.has(r)&&(e.set(r,!0),a.push(r.dataset.sid))}a.length&&Tracker.dropTag('altStoreDisplayed',{sids:a.slice(0,20)})}),1e3)},_checkSeenStores:function(){const t=[];for(const e of this.$data._trackedAvails)t.push(e),this.$data._trackedAvails.delete(e);t.length>0&&Tracker.dropTag('storeDisplayed',{sids:t.slice(0,20)})},visibleStoreHandler:function(t,e){t.forEach((t=>{t.isIntersecting&&t.intersectionRatio>=e.thresholds[0]&&(e.unobserve(t.target),this.$data._trackedAvails.add(t.target.dataset.sid))}))},updateLocale:function(t,e,i,s){const a=[],o=[];return t!==e&&(a.push(t),i!==t&&a.push(i),e&&!a.includes(e)&&o.push(e),!s||a.includes(s)||o.includes(s)||o.push(s)),a.length&&hostCom.send('awe:updateLocale',{add:a,remove:o}),{add:a,remove:o}},closeLockdownNotif:function(){this.lockdownNotifClosed=!0},clearAddress:function(){this.location.address=''},isDefaultProduct:function(t){if(!t.ean&&!t.eans)return!1;const e=this.defaultEan&&this.defaultEan[this.country];return t.ean===e||t.eans&&t.eans.includes(e)},setSafeFrame:function(){this.withSafeFrame=!0,this.tracker.safeFrameDetector='postmessage'},setDefaultAddress:async function(){try{const t=await Utils.queryMapbox(this.defaultCountry,[this.defaultCountry],this.locale,1);if(t&&t[0]){const e=Utils.parseFeature(t[0]);this.$data._location=e}}catch(t){console.error('setDefaultAddress error'),console.error(t)}},monitorHeight:function(){if(window.ResizeObserver){new ResizeObserver((([t])=>{const e=t?.borderBoxSize?.[0]?.blockSize||t?.contentRect?.height;e!==this.$data._currentHeight&&(hostCom.send('awe:resize',{height:e}),this.$data._currentHeight=e)})).observe(document.getElementById('app-ctnr'))}else window.addEventListener('resize',this.resizeWindow)},cleanOriginUrl:function(t){return t?(t=t.replace(/^(https?:)?\/\/content\.static-swaven\.com/,'https://content-nocache.static-swaven.com').replace(/^\/\//,'https://'),encodeURIComponent(t)):''},updateTrackingData(){let t=0,e=0,i=0,s=0,a=[];for(let o=0;o<this.availabilities.length;o++){const r=this.availabilities[o];r.price.amount&&(t+=r.price.amount,e++),r.store.distance&&(i+=r.store.distance,s++),a.includes(r.retailer.id)||a.push(r.retailer.id)}this.$data._trkData.nbres=this.availabilities.length,this.$data._trkData.avgpc=(t/e).toFixed(2),this.$data._trkData.avgdst=(i/s).toFixed(2),this.$data._trkData.nbrefret=a.length},injectGlassbox:function(t,e,i){const s=`${window.location.href.includes('?')?'&':'?'}_cls_s=${t}`;history.pushState(null,'',window.location.href+s);const a=document.createElement('script');a.id='_cls_detector',a.setAttribute('data-clsconfig',`reportURI=${e}`);const o=i;a.src=`https://cdn.gbqofs.com/${o}/p/detector-dom.min.js`,document.body.appendChild(a)}}};Vue.config.errorHandler=function(t,e,i){console.error('Error: '+t.message),Tracker.log('error',{msg:t.message,stack:t.stack,info:i})},void 0===window.AbortController&&(window.AbortController=function(){return{signal:null,abort:function(){}}});
//# sourceMappingURL=app.js.map
